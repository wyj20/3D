<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D-FIMS æ‰“å°è€—æç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --main: #00acc1; --bg: #f8f9fa; --nav: #212121; --danger: #ff5252; --warn: #ff9800; --success: #4caf50;
            --f-base: clamp(14px, 4vw, 18px);
            --f-card: clamp(16px, 4.5vw, 22px);
            --grid-cols: 2; 
        }
        body { font-family: 'Segoe UI', 'PingFang SC', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; font-size: var(--f-base); -webkit-tap-highlight-color: transparent; color: #333; }
        
        .tabs { display: flex; background: var(--nav); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .tab-btn { flex: 1; padding: 14px 2px; color: #888; border: none; background: none; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .tab-btn.active { color: white; border-bottom: 3px solid var(--main); font-weight: bold; }
        .tab-count { font-size: 0.7rem; margin-top: 2px; opacity: 0.7; }

        .search-container { background: white; padding: 8px 12px; position: sticky; top: 58px; z-index: 90; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .search-row { display: flex; gap: 8px; align-items: center; }
        .search-input { flex: 1; padding: 8px 15px; border: 1.5px solid #eee; border-radius: 20px; font-size: 0.85rem; outline: none; background: #fafafa; }
        .filter-toggle { width: 36px; height: 36px; border-radius: 10px; border: 1.5px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; background: #fff; transition: all 0.2s; }
        .filter-toggle.active { border-color: var(--main); color: var(--main); background: #f0fbfc; }
        
        .filter-tray { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fff; }
        .filter-tray.active { max-height: 140px; padding-top: 10px; padding-bottom: 5px; }
        
        .scroll-row { 
            display: flex; gap: 12px; overflow-x: auto; white-space: nowrap; padding: 5px 5px 12px 5px; align-items: center;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .scroll-row::-webkit-scrollbar { display: none; }
        
        .palette-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid transparent; flex-shrink: 0; cursor: pointer; }
        .palette-dot.active { border-color: var(--main); transform: scale(1.15); box-shadow: 0 0 5px rgba(0,172,193,0.3); }
        .palette-dot.clear { background: #eee; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: #777; border-radius: 8px; width: 40px; height: 24px; flex-shrink: 0; }

        .filter-dot { padding: 6px 12px; border-radius: 14px; font-size: 0.7rem; background: #f2f2f2; color: #666; white-space: nowrap; border: 1px solid transparent; flex-shrink: 0; }
        .filter-dot.active { background: #e0f7f9; color: var(--main); border-color: var(--main); font-weight: bold; }

        .container { padding: 12px; display: grid; grid-template-columns: repeat(var(--grid-cols), 1fr); gap: 12px; align-content: start; }
        .card { border-radius: 16px; padding: 1.1rem; position: relative; min-height: 180px; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.12); color: white; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.1s; }
        .card:active { transform: scale(0.97); }
        .card .brand { font-size: var(--f-card); font-weight: 900; line-height: 1.1; margin-bottom: 2px; }
        .card .type { font-size: 0.85rem; font-weight: 600; opacity: 0.9; }
        .card .notes { font-size: 0.65rem; opacity: 0.8; margin-top: 5px; font-style: italic; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; max-width: 92%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .card-footer { display: flex; flex-direction: column; margin-top: auto; padding-top: 12px; gap: 12px; }
        .action-area { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .action-btn { width: 100%; background: rgba(128,128,128,0.1); border: 1.5px solid currentColor; color: inherit; border-radius: 8px; padding: 10px 2px; font-size: 0.75rem; font-weight: 900; white-space: nowrap; text-align: center; opacity: 0.95; }
        .card .count { font-size: 2rem; font-weight: 900; line-height: 1; text-align: right; width: 100%; display: flex; align-items: baseline; justify-content: flex-end; }
        .card .count::after { content: 'å·'; font-size: 0.75rem; font-weight: normal; margin-left: 4px; opacity: 0.8; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        #scanModal { z-index: 2000; }
        #warnModal { z-index: 3000; }
        
        .modal-content { background: white; width: 90%; max-width: 420px; border-radius: 26px; padding: 25px; color: #333; box-shadow: 0 10px 40px rgba(0,0,0,0.4); overflow-y: auto; max-height: 90vh; }
        .btn-row { display: flex; gap: 12px; margin-top: 18px; }
        .btn { flex: 1; padding: 15px; border-radius: 14px; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .btn-main { background: var(--main); color: white; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* å¿«æ·é¢„è®¾æŒ‰é’®æ ·å¼ */
        .preset-area { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed #eee; }
        .preset-item { flex-shrink: 0; padding: 10px 15px; border-radius: 12px; background: #f8f9fa; border: 1.5px solid #eee; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 80px; }
        .preset-item:active { background: #eef; transform: scale(0.95); }
        .preset-color { width: 15px; height: 15px; border-radius: 50%; }
        .preset-text { font-size: 0.7rem; font-weight: bold; color: #555; }
        
        .sync-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1.5px solid #eee; border-radius: 12px; font-size: 0.85rem; box-sizing: border-box; background: #fafafa; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { background: #f2f2f2; color: #555; padding: 8px 14px; border-radius: 10px; font-size: 0.75rem; border: 1px solid #e8e8e8; cursor: pointer; }
        .tag.active-touch { background: #ddd; }
        
        .fab { position: fixed; bottom: 25px; right: 25px; width: 68px; height: 68px; background: var(--main); color: white; border-radius: 50%; border: none; font-size: 38px; box-shadow: 0 8px 20px rgba(0,172,193,0.4); z-index: 99; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('sealed')">æ€»è€—æåº“<span id="cnt-sealed" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('inuse')">æ­£åœ¨ä½¿ç”¨<span id="cnt-inuse" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('opened')">å¼€å°å¤‡ç”¨<span id="cnt-opened" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('finished')">æ¶ˆè€—è®°å½•<span id="cnt-finished" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
</div>

<div id="searchBox" class="search-container">
    <div class="search-row">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æ£€ç´¢å“ç‰Œã€æè´¨ã€å¤‡æ³¨..." oninput="render()">
        <div id="filterBtn" class="filter-toggle" onclick="toggleFilterTray()">âš™ï¸</div>
    </div>
    <div id="filterTray" class="filter-tray">
        <div id="paletteBar" class="scroll-row" style="border-bottom:1px dashed #eee; margin-bottom:8px;"></div>
        <div id="filterDots" class="scroll-row"></div>
    </div>
</div>

<div id="content" class="container"></div>

<div id="warnModal" class="modal"><div class="modal-content" style="text-align:center;"><div id="warnIcon" style="font-size:55px;">âš ï¸</div><div id="warnTitle" style="font-weight:bold;font-size:1.2rem;margin:10px 0;">ç³»ç»Ÿç¡®è®¤</div><p id="warnMsg" style="color:#666; font-size:0.95rem; margin-bottom:28px; line-height:1.6;"></p><div id="btnContainer" class="btn-row"><button class="btn" id="warnLeftBtn"></button><button class="btn" id="warnRightBtn"></button></div></div></div>

<div id="newModal" class="modal"><div class="modal-content">
    <div id="modalActionTitle" style="font-weight:bold;font-size:1.1rem;text-align:center;margin-bottom:15px; color:var(--main)">è€—æå…¥åº“ç™»è®°</div>
    
    <div id="presetArea" class="preset-area"></div>

    <div style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <label style="font-size:0.7rem;color:#999;">ç”Ÿäº§å“ç‰Œ</label>
            <a href="javascript:void(0)" onclick="copyLastEntry()" style="font-size:0.7rem; color:var(--main); text-decoration:none;">ğŸ“‹ å¤åˆ¶ä¸Šæ¬¡å½•å…¥</a>
        </div>
        <div style="display:flex; gap:8px;">
            <input type="text" id="inBrand" class="sync-input" style="margin-bottom:0;" placeholder="è¾“å…¥æˆ–ç‚¹å‡»ä¸‹æ–¹æ ‡ç­¾">
            <button onclick="startScan()" style="width:50px; border-radius:12px; border:1.5px solid var(--main); background:white; color:var(--main); font-size:1.1rem;">ğŸ“·</button>
        </div>
        <div id="brandTags" class="tag-container"></div>
    </div>
    
    <div style="margin-bottom:12px;">
        <label style="font-size:0.7rem;color:#999;">æè´¨ç±»å‹</label>
        <input type="text" id="inType" class="sync-input" placeholder="PLA / PETG...">
        <div id="typeTags" class="tag-container"></div>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:12px;">
        <div style="flex:2;">
            <label style="font-size:0.7rem;color:#999;">è¡¥å……å¤‡æ³¨</label>
            <input type="text" id="inNotes" placeholder="ä¸ç»¸ / ç£¨ç ‚..." class="sync-input">
        </div>
        <div style="flex:1;">
            <label style="font-size:0.7rem;color:#999;">è‰²å—</label>
            <input type="color" id="inColor" value="#00acc1" style="width:100%;height:45px;border:none;border-radius:10px; background:none; padding:0;">
        </div>
    </div>

    <div id="countRow" style="margin-bottom:12px;">
        <label style="font-size:0.7rem;color:#999;">å…¥åº“æ•°é‡ (å·)</label>
        <input type="number" id="inCount" value="1" class="sync-input" onclick="this.select()">
    </div>

    <div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('newModal')">å–æ¶ˆ</button><button class="btn btn-main" id="saveNewBtn" onclick="saveNew()">ç¡®è®¤å…¥åº“</button></div>
</div></div>

<div id="scanModal" class="modal" style="background: #000; flex-direction: column;">
    <div id="reader" style="width: 100%; height: 80vh;"></div>
    <button class="btn btn-cancel" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); width:80%; z-index:2001;" onclick="stopScan()">å–æ¶ˆæ‰«æ</button>
</div>

<div id="adjustModal" class="modal"><div class="modal-content"><div style="font-weight:bold;font-size:1.2rem;text-align:center;margin-bottom:20px;">åº“å­˜é‡ç²¾ç¡®è°ƒæ•´</div>
    <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin:25px 0;">
        <button style="width:65px;height:65px;font-size:2rem;border-radius:15px;border:1px solid #ddd;background:#fcfcfc" onclick="stepAdjust(-1)">-</button>
        <input type="number" id="adjNum" style="width:110px;height:65px;text-align:center;font-size:2rem;font-weight:bold;border:2px solid var(--main);border-radius:15px;outline:none;" onclick="this.select()" onfocus="this.select()">
        <button style="width:65px;height:65px;font-size:2rem;border-radius:15px;border:1px solid #ddd;background:#fcfcfc" onclick="stepAdjust(1)">+</button>
    </div>
    <div style="text-align:center; margin-bottom:15px;"><a href="javascript:void(0)" style="color:var(--main); font-size:0.85rem; font-weight:bold; text-decoration:none;" onclick="openEditMode()">âœ ä¿®è®¢èµ„æ–™å±æ€§</a></div>
    <div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('adjustModal')">è¿”å›</button><button class="btn btn-main" onclick="confirmAdj()">ä¿å­˜å˜åŠ¨</button></div>
    <button class="btn btn-danger" style="width:100%; margin-top:20px; font-size:0.9rem;" onclick="closeModal('adjustModal'); setTimeout(requestDelete, 100)">å½»åº•ç§»é™¤è¯¥è®°å½•</button>
</div></div>

<input type="file" id="localRestoreInput" style="display:none" accept="*/*" onchange="importLocalBackup(this)">
<button id="fab" class="fab" onclick="openNewMode()">+</button>

<script>
    const MASTER_KEY = '3D_FIMS_STABLE_DB';
    const INITIAL_DB = {
        sealed: [], inuse: [], opened: [], finished: [], 
        config: { brands: ['æ‹“ç«¹', 'è‰ºæ¾', 'JAYO', 'eSUN'], types: ['PLA', 'PETG', 'ABS', 'TPU'], barcodeMap: {}, history: [] },
        settings: { columns: 2, sortOrder: 'brand', ghToken: '', ghRepo: '', lastSync: 0 }, 
        lastBackup: 0, lastChange: 0
    };

    let db = JSON.parse(localStorage.getItem(MASTER_KEY)) || INITIAL_DB;
    let currentTab = 'sealed', activeIdx = null, activeFrom = '', activeFilter = '', activeColor = '', isEditMode = false;
    let html5QrCode, pendingBarcode = null;

    function saveDB() { db.lastChange = Date.now(); localStorage.setItem(MASTER_KEY, JSON.stringify(db)); document.documentElement.style.setProperty('--grid-cols', db.settings.columns); }
    function getContrastColor(hex) { const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return (((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128) ? '#000' : '#FFF'; }

    // --- å¿«æ·å½•å…¥æ ¸å¿ƒé€»è¾‘ ---
    function renderPresets() {
        const area = document.getElementById('presetArea');
        if (!db.config.history) db.config.history = [];
        // å–æœ€åä½¿ç”¨çš„å‰ 5 ä¸ªä¸é‡å¤çš„ç»„åˆ
        const unique = [];
        [...db.config.history].reverse().forEach(item => {
            if (unique.length < 5 && !unique.find(u => u.brand === item.brand && u.type === item.type && u.color === item.color && u.notes === item.notes)) {
                unique.push(item);
            }
        });

        if (unique.length === 0) {
            area.innerHTML = '<div style="color:#ccc; font-size:0.7rem; width:100%; text-align:center;">å¸¸ç”¨é¢„è®¾å°†åœ¨æ­¤è‡ªåŠ¨ç”Ÿæˆ</div>';
            return;
        }

        area.innerHTML = unique.map(item => `
            <div class="preset-item" onclick="quickFill('${item.brand}', '${item.type}', '${item.color}', '${item.notes || ''}')">
                <div class="preset-color" style="background:${item.color}"></div>
                <div class="preset-text">${item.brand}</div>
                <div class="preset-text" style="opacity:0.6">${item.type}</div>
            </div>
        `).join('');
    }

    function quickFill(b, t, c, n) {
        document.getElementById('inBrand').value = b;
        document.getElementById('inType').value = t;
        document.getElementById('inColor').value = c;
        document.getElementById('inNotes').value = n;
        showNotice("é¢„è®¾å·²å¡«å……", `å·²é€‰æ‹©ï¼š${b} ${t}`);
    }

    function copyLastEntry() {
        if (!db.config.history || db.config.history.length === 0) return;
        const last = db.config.history[db.config.history.length - 1];
        quickFill(last.brand, last.type, last.color, last.notes);
    }

    function showModal(id) { 
        document.getElementById(id).style.display = 'flex'; 
        if(id === 'newModal') renderPresets(); // æ¯æ¬¡æ‰“å¼€å…¥åº“å¼¹çª—åˆ·æ–°é¢„è®¾
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- æ‰«æåŠŸèƒ½ ---
    async function startScan() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            showNotice("ç¯å¢ƒé™åˆ¶", "è¯·åœ¨ HTTPS ç½‘å€ä¸‹ä½¿ç”¨æ‰«æåŠŸèƒ½", "error"); return;
        }
        showModal('scanModal');
        html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 250, height: 180 } }, (txt) => handleScanSuccess(txt), (e) => {});
        } catch (err) { closeModal('scanModal'); showNotice("ç›¸æœºé”™è¯¯", "æ— æ³•è°ƒå–æ‘„åƒå¤´", "error"); }
    }
    function stopScan() { if (html5QrCode) html5QrCode.stop().then(() => closeModal('scanModal')).catch(() => closeModal('scanModal')); else closeModal('scanModal'); }
    function handleScanSuccess(code) {
        stopScan();
        const info = (db.config.barcodeMap || {})[code];
        if (info) quickFill(info.brand, info.type, info.color, info.notes);
        else { showNotice("æ–°æ¡ç è®°å½•", "æ‰‹åŠ¨ä¿å­˜åç³»ç»Ÿå°†è®°ä½æ­¤æ¡ç "); pendingBarcode = code; }
    }

    // --- ä¸šåŠ¡åŸºç¡€åŠŸèƒ½ ---
    function saveNew() {
        const b = document.getElementById('inBrand').value.trim(), t = document.getElementById('inType').value.trim(), c = document.getElementById('inColor').value, nts = document.getElementById('inNotes').value.trim();
        if (!b || !t) return;
        
        // æ›´æ–°å¸¸ç”¨é…ç½®å’Œå†å²è®°å½•
        if (!db.config.brands.includes(b)) db.config.brands.push(b);
        if (!db.config.types.includes(t)) db.config.types.push(t);
        if (!db.config.history) db.config.history = [];
        db.config.history.push({ brand: b, type: t, color: c, notes: nts });
        if (db.config.history.length > 50) db.config.history.shift(); // åªä¿ç•™æœ€è¿‘50æ¡

        if (pendingBarcode) {
            if (!db.config.barcodeMap) db.config.barcodeMap = {};
            db.config.barcodeMap[pendingBarcode] = { brand: b, type: t, color: c, notes: nts };
            pendingBarcode = null;
        }

        let n = parseInt(document.getElementById('inCount').value); if (isNaN(n) || n < 1) n = 1;
        if (isEditMode) db[activeFrom][activeIdx] = { ...db[activeFrom][activeIdx], brand: b, type: t, color: c, notes: nts };
        else {
            let exist = db.sealed.find(i => i.brand === b && i.type === t && i.color === c && i.notes === nts);
            if (exist) exist.count += n; else db.sealed.push({ brand: b, type: t, color: c, count: n, notes: nts });
        }
        saveDB(); render(); closeModal('newModal');
        // é‡ç½®è¡¨å•
        document.getElementById('inBrand').value = ''; document.getElementById('inType').value = ''; document.getElementById('inNotes').value = ''; document.getElementById('inCount').value = '1';
    }

    function render() {
        const container = document.getElementById('content'); const searchBox = document.getElementById('searchBox');
        const term = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = ''; updateCounts(); document.documentElement.style.setProperty('--grid-cols', db.settings.columns);
        const isSet = currentTab === 'settings'; document.getElementById('fab').style.display = isSet ? 'none' : 'flex'; searchBox.style.display = isSet ? 'none' : 'block';

        if (isSet) {
            container.innerHTML = `<div class="settings-group"><div class="settings-title">ğŸ¨ æ˜¾ç¤ºè§„æ ¼</div><div class="select-picker">${[1,2,3].map(n => `<div class="select-option ${db.settings.columns==n?'active':''}" onclick="updateCols(${n})">${n} åˆ—</div>`).join('')}</div></div>
                <div class="settings-group"><div class="settings-title">â˜ï¸ GitHub å¤‡ä»½</div><input type="password" id="ghToken" class="sync-input" value="${db.settings.ghToken}" placeholder="GitHub Token"><input type="text" id="ghRepo" class="sync-input" value="${db.settings.ghRepo}" placeholder="wyj20/3D-FIMS">
                <div style="display:flex; gap:12px;"><button class="btn btn-main" onclick="githubSync('upload')">ä¸Šä¼ </button><button class="btn btn-cancel" onclick="githubSync('download')">ä¸‹è½½</button></div></div>
                <div class="settings-group"><div class="settings-title">âš ï¸ å±é™©åŒºåŸŸ</div><button class="btn btn-danger" style="width:100%" onclick="requestReset()">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button></div>`;
            return;
        }

        renderFilters(); renderPalette();
        let sorted = [...db[currentTab]].sort((a,b) => (a.brand||"").localeCompare(b.brand||"",'zh'));
        sorted.forEach(item => {
            if(activeFilter && item.type !== activeFilter) return;
            if(activeColor && item.color !== activeColor) return;
            if(!item.brand.toLowerCase().includes(term) && !item.type.toLowerCase().includes(term)) return;
            const realIdx = db[currentTab].indexOf(item), txtC = getContrastColor(item.color);
            const card = document.createElement('div'); card.className = 'card'; card.style.backgroundColor = item.color; card.style.color = txtC;
            card.onclick = () => { activeIdx = realIdx; activeFrom = currentTab; document.getElementById('adjNum').value = item.count; showModal('adjustModal'); };
            let btns = ''; const btnS = `style="color:${txtC}; border-color:${txtC}"`;
            if(currentTab === 'sealed') btns = `<button class="action-btn" ${btnS} onclick="event.stopPropagation(); checkUnseal(${realIdx})">å¼€å¯ä½¿ç”¨</button>`;
            else if(currentTab === 'inuse') btns = `<button class="action-btn" ${btnS} onclick="event.stopPropagation(); confirmFinish(${realIdx},'inuse')">è€—å°½ç»“å­˜</button>`;
            card.innerHTML = `<div class="brand">${item.brand}</div><div class="type">${item.type}</div>${item.notes?`<div class="notes"># ${item.notes}</div>`:''}<div class="card-footer"><div class="action-area">${btns}</div><div class="count">${item.count}</div></div>`;
            container.appendChild(card);
        });
        renderTags();
    }

    function renderTags() {
        const build = (cat, list, inputId) => {
            const html = list.map(v => `<span class="tag" onclick="setIn('${inputId}', '${v}')">${v}</span>`).join('');
            document.getElementById(cat + 'Tags').innerHTML = html + `<span class="tag" style="border-style:dashed; color:var(--main)" onclick="addTag('${cat}')">+</span>`;
        };
        build('brand', db.config.brands, 'inBrand');
        build('type', db.config.types, 'inType');
    }

    function setIn(id, v) { document.getElementById(id).value = v; document.getElementById(id).focus(); }
    function openNewMode() { isEditMode = false; document.getElementById('modalActionTitle').innerText = 'è€—æå…¥åº“ç™»è®°'; showModal('newModal'); }
    function openEditMode() { isEditMode = true; closeModal('adjustModal'); const item = db[activeFrom][activeIdx]; document.getElementById('inBrand').value = item.brand; document.getElementById('inType').value = item.type; document.getElementById('inNotes').value = item.notes || ''; document.getElementById('inColor').value = item.color; showModal('newModal'); }
    function checkUnseal(idx) { let item = db.sealed[idx]; item.count--; if(item.count<=0) db.sealed.splice(idx,1); let exist = db.inuse.find(i=>i.brand===item.brand && i.type===item.type && i.color===item.color); if(exist) exist.count++; else db.inuse.push({...item, count:1}); saveDB(); render(); }
    function confirmFinish(idx, f) { db[f].splice(idx,1); saveDB(); render(); }
    function confirmAdj() { db[activeFrom][activeIdx].count = parseInt(document.getElementById('adjNum').value); saveDB(); render(); closeModal('adjustModal'); }
    function switchTab(t) { currentTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active'); render(); }
    function showNotice(title, msg, type = 'success') { showCustomWarn(title, msg, "", "hide", null, "å¥½", type === 'success' ? "btn-success" : "btn-danger", () => closeModal('warnModal')); }
    function showCustomWarn(t, m, lT, lC, lF, rT, rC, rF) { document.getElementById('warnTitle').innerText = t; document.getElementById('warnMsg').innerText = m; const lB = document.getElementById('warnLeftBtn'), rB = document.getElementById('warnRightBtn'); if(lC==="hide"){lB.style.display="none"}else{lB.style.display="block";lB.innerText=lT;lB.className="btn "+lC;lB.onclick=lF;} rB.innerText=rT; rB.className="btn "+rC; rB.onclick=rF; showModal('warnModal'); }
    function updateCols(n) { db.settings.columns = n; saveDB(); render(); }
    function stepAdjust(v) { let el = document.getElementById('adjNum'); el.value = Math.max(1, (parseInt(el.value)||1)+v); }
    function updateCounts() { ['sealed','inuse','opened','finished'].forEach(k => { const el = document.getElementById('cnt-'+k); if(el) el.innerText = db[k].reduce((s,i)=>s+(parseInt(i.count)||0),0); }); }
    function renderFilters() { /* ä¿æŒåŸé€»è¾‘ */ }
    function renderPalette() { /* ä¿æŒåŸé€»è¾‘ */ }
    function addTag(c) { let v = prompt("æ–°å±æ€§:"); if(v) { db.config[c==='brand'?'brands':'types'].push(v); renderTags(); saveDB(); } }
    async function githubSync(action) { /* ä¿æŒåŸé€»è¾‘ */ }
    function requestReset() { if(confirm("ç¡®è®¤æ¸…ç©ºæ•°æ®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    
    render();
</script>
</body>
</html>
