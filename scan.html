<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D-FIMS è€—æç®¡ç†</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --main: #00acc1; --bg: #f4f7f9; --nav: #1a1a1a; --danger: #ff5252; --warn: #ff9800; --success: #4caf50;
            --card-bg: #ffffff; --text: #333;
            --f-base: clamp(14px, 4vw, 18px);
            --grid-cols: 2; 
        }
        body { font-family: -apple-system, 'PingFang SC', sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); user-select: none; }
        
        /* å¯¼èˆªæ ä¼˜åŒ– */
        .tabs { display: flex; background: var(--nav); position: sticky; top: 0; z-index: 100; padding-top: env(safe-area-inset-top); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .tab-btn { flex: 1; padding: 15px 5px; color: #999; border: none; background: none; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
        .tab-btn.active { color: #fff; font-weight: bold; }
        .tab-btn.active::after { content: ''; width: 20px; height: 3px; background: var(--main); margin-top: 5px; border-radius: 2px; }
        .tab-count { font-size: 0.65rem; margin-top: 2px; opacity: 0.6; }

        /* æœç´¢æ¡†æµ®åŠ¨æ„Ÿ */
        .search-container { background: white; padding: 12px 16px; position: sticky; top: 65px; z-index: 90; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .search-row { display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 10px 18px; border: 1px solid #eee; border-radius: 25px; background: #f8f8f8; font-size: 0.9rem; outline: none; }

        /* å®¹å™¨ç½‘æ ¼ */
        .container { padding: 16px; display: grid; grid-template-columns: repeat(var(--grid-cols), 1fr); gap: 14px; }
        
        /* è€—æå¡ç‰‡ç¾åŒ– */
        .card { border-radius: 20px; padding: 18px; position: relative; min-height: 160px; color: white; display: flex; flex-direction: column; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: 0.1s; border: 1px solid rgba(255,255,255,0.1); }
        .card:active { transform: scale(0.96); opacity: 0.9; }
        .card .brand { font-size: 1.2rem; font-weight: 800; margin-bottom: 2px; letter-spacing: -0.5px; }
        .card .type { font-size: 0.8rem; font-weight: 600; opacity: 0.9; }
        .card .notes { font-size: 0.65rem; background: rgba(0,0,0,0.15); padding: 3px 8px; border-radius: 6px; margin-top: 8px; align-self: flex-start; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .count { margin-top: auto; font-size: 2.2rem; font-weight: 900; text-align: right; line-height: 1; }
        .card .count::after { content: 'å·'; font-size: 0.7rem; margin-left: 4px; opacity: 0.7; font-weight: normal; }

        /* å¼¹çª—å‡çº§ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 92%; max-width: 400px; border-radius: 30px; padding: 25px; box-sizing: border-box; animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-title { font-size: 1.2rem; font-weight: bold; text-align: center; margin-bottom: 20px; color: var(--main); }

        /* å¿«æ·é¢„è®¾ä¼˜åŒ– */
        .preset-container { background: #f8f9fa; border-radius: 18px; padding: 12px; margin-bottom: 20px; }
        .preset-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .preset-scroll::-webkit-scrollbar { display: none; }
        .preset-item { flex-shrink: 0; background: white; padding: 10px; border-radius: 14px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 70px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }

        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 0.75rem; color: #999; margin-left: 5px; margin-bottom: 5px; display: block; }
        .custom-input { width: 100%; padding: 14px; border-radius: 14px; border: 1.5px solid #eee; font-size: 0.95rem; box-sizing: border-box; background: #fafafa; outline: none; transition: 0.2s; }
        .custom-input:focus { border-color: var(--main); background: white; }

        /* æŒ‰é’®ç»„ */
        .btn-row { display: flex; gap: 12px; margin-top: 20px; }
        .btn { flex: 1; padding: 16px; border-radius: 16px; border: none; font-size: 1rem; font-weight: bold; transition: 0.2s; cursor: pointer; }
        .btn-main { background: var(--main); color: white; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-danger-outline { background: #fff; color: var(--danger); border: 1.5px solid var(--danger); margin-top: 15px; width: 100%; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--main); color: white; border-radius: 50%; border: none; font-size: 35px; box-shadow: 0 10px 25px rgba(0,172,193,0.4); z-index: 99; display: flex; align-items: center; justify-content: center; }
        
        .tag { background: #eee; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; margin: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="tabs" id="mainTabs">
    <button class="tab-btn active" onclick="switchTab('sealed')">æ€»è€—æåº“<span id="cnt-sealed" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('inuse')">æ­£åœ¨ä½¿ç”¨<span id="cnt-inuse" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('opened')">å¼€å°å¤‡ç”¨<span id="cnt-opened" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('finished')">ç»Ÿè®¡è®°å½•<span id="cnt-finished" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('settings')">è®¾ç½®</button>
</div>

<div id="searchBox" class="search-container">
    <div class="search-row">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœç´¢å“ç‰Œã€æè´¨ã€å¤‡æ³¨..." oninput="render()">
    </div>
</div>

<div id="content" class="container"></div>

<div id="newModal" class="modal"><div class="modal-content">
    <div class="modal-title" id="modalActionTitle">è€—æå…¥åº“ç™»è®°</div>
    
    <div class="preset-container">
        <div style="font-size: 0.65rem; color: #bbb; margin-bottom: 8px; text-align: center;">å¸¸ç”¨è§„æ ¼å¿«æ·å¡«å……</div>
        <div id="presetArea" class="preset-scroll"></div>
    </div>

    <div class="input-group">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
            <span class="input-label">ç”Ÿäº§å“ç‰Œ</span>
            <span style="font-size:0.7rem; color:var(--main)" onclick="copyLastEntry()">ğŸ“‹ å¤åˆ¶ä¸Šæ¬¡</span>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="inBrand" class="custom-input" placeholder="å“ç‰Œ">
            <button onclick="startScan()" style="width:55px; border-radius:14px; border:1.5px solid var(--main); background:#fff; color:var(--main); font-size:1.2rem;">ğŸ“·</button>
        </div>
        <div id="brandTags" style="margin-top:8px;"></div>
    </div>

    <div class="input-group">
        <span class="input-label">æè´¨ç±»å‹</span>
        <input type="text" id="inType" class="custom-input" placeholder="PLA / PETG / TPU...">
        <div id="typeTags" style="margin-top:8px;"></div>
    </div>

    <div style="display:flex; gap:15px;">
        <div class="input-group" style="flex:2">
            <span class="input-label">å¤‡æ³¨ (é¢œè‰²/ç‰¹æ€§)</span>
            <input type="text" id="inNotes" class="custom-input" placeholder="å¦‚ï¼šä¸ç»¸é‡‘">
        </div>
        <div class="input-group" style="flex:1">
            <span class="input-label">è‰²å—</span>
            <input type="color" id="inColor" value="#00acc1" style="width:100%; height:48px; border:none; background:none;">
        </div>
    </div>

    <div class="input-group" id="countRow">
        <span class="input-label">å…¥åº“å·æ•°</span>
        <input type="number" id="inCount" value="1" class="custom-input" onclick="this.select()">
    </div>

    <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('newModal')">å–æ¶ˆ</button>
        <button class="btn btn-main" onclick="saveNew()">ç¡®è®¤å­˜å…¥</button>
    </div>
</div></div>

<div id="adjustModal" class="modal"><div class="modal-content">
    <div class="modal-title">åº“å­˜é‡è°ƒæ•´</div>
    <div style="display:flex; align-items:center; justify-content:center; gap:20px; margin:30px 0;">
        <button style="width:60px; height:60px; font-size:2rem; border-radius:18px; border:1px solid #ddd; background:#f9f9f9" onclick="stepAdjust(-1)">-</button>
        <input type="number" id="adjNum" style="width:100px; height:60px; text-align:center; font-size:2rem; font-weight:900; border:2px solid var(--main); border-radius:18px; outline:none;" onclick="this.select()">
        <button style="width:60px; height:60px; font-size:2rem; border-radius:18px; border:1px solid #ddd; background:#f9f9f9" onclick="stepAdjust(1)">+</button>
    </div>
    <div style="text-align:center; margin-bottom:20px;">
        <a href="javascript:void(0)" style="color:var(--main); font-size:0.85rem; font-weight:600; text-decoration:none;" onclick="openEditMode()">âœ ä¿®æ”¹åŸºç¡€å±æ€§</a>
    </div>
    <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('adjustModal')">è¿”å›</button>
        <button class="btn btn-main" onclick="confirmAdj()">ä¿å­˜</button>
    </div>
    <button class="btn btn-danger-outline" onclick="requestDelete()">å½»åº•ä»åº“ä¸­ç§»é™¤</button>
</div></div>

<div id="warnModal" class="modal"><div class="modal-content" style="text-align:center;">
    <div id="warnIcon" style="font-size:50px; margin-bottom:10px;">âš ï¸</div>
    <div id="warnTitle" style="font-weight:bold; font-size:1.1rem; margin-bottom:10px;"></div>
    <div id="warnMsg" style="color:#666; font-size:0.9rem; margin-bottom:25px;"></div>
    <div class="btn-row">
        <button class="btn btn-cancel" id="warnLeftBtn"></button>
        <button class="btn" id="warnRightBtn"></button>
    </div>
</div></div>

<div id="scanModal" class="modal" style="background:#000; flex-direction:column;">
    <div id="reader" style="width:100%; height:75vh;"></div>
    <button class="btn btn-cancel" style="width:80%; margin:20px auto;" onclick="stopScan()">å…³é—­ç›¸æœº</button>
</div>

<button id="fab" class="fab" onclick="openNewMode()">+</button>

<script>
    const MASTER_KEY = '3D_FIMS_STABLE_DB';
    const INITIAL_DB = {
        sealed: [], inuse: [], opened: [], finished: [], 
        config: { brands: ['æ‹“ç«¹', 'è‰ºæ¾', 'JAYO', 'eSUN'], types: ['PLA', 'PETG', 'ABS', 'TPU'], barcodeMap: {}, history: [] },
        settings: { columns: 2, sortOrder: 'brand', lastSync: 0 }, 
        lastChange: 0
    };

    let db = JSON.parse(localStorage.getItem(MASTER_KEY)) || INITIAL_DB;
    let currentTab = 'sealed', activeId = null, activeFrom = '', isEditMode = false;
    let html5QrCode, pendingBarcode = null;

    // --- æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†å®šä½ä¸åˆ é™¤ ---
    function saveDB() { db.lastChange = Date.now(); localStorage.setItem(MASTER_KEY, JSON.stringify(db)); }
    
    // ç”Ÿæˆå”¯ä¸€IDé˜²æ­¢è¯¯åˆ 
    function generateId() { return Date.now() + Math.random().toString(36).substr(2, 5); }

    function requestDelete() {
        // é€šè¿‡IDåœ¨æ•°ç»„ä¸­å¯»æ‰¾çœŸå®å¯¹è±¡
        const list = db[activeFrom];
        const index = list.findIndex(i => i.id === activeId);
        if (index === -1) { alert("æ‰¾ä¸åˆ°è¯¥è€—æè®°å½•"); return; }
        
        const item = list[index];
        showCustomWarn("å½»åº•ç§»é™¤", `ç¡®å®šè¦ä»åº“ä¸­æ°¸ä¹…ç§»é™¤ ã€${item.brand} ${item.type}ã€‘å—ï¼Ÿä¸å¯æ¢å¤ã€‚`, 
            "å–æ¶ˆ", "btn-cancel", () => closeModal('warnModal'), 
            "ç¡®è®¤ç§»é™¤", "btn-main", () => {
                list.splice(index, 1);
                saveDB(); render();
                closeModal('adjustModal');
                closeModal('warnModal');
            }
        );
        // ä¿®æ­£åˆ é™¤æŒ‰é’®æ ·å¼
        document.getElementById('warnRightBtn').style.background = 'var(--danger)';
    }

    // --- å¿«æ·å½•å…¥ä¸æ’ç‰ˆ ---
    function renderPresets() {
        const area = document.getElementById('presetArea');
        const history = db.config.history || [];
        const unique = [];
        [...history].reverse().forEach(h => {
            if (unique.length < 5 && !unique.find(u => u.brand === h.brand && u.type === h.type && u.color === h.color)) unique.push(h);
        });

        if (unique.length === 0) { area.innerHTML = '<div style="width:100%; color:#ccc; font-size:0.7rem; text-align:center;">æš‚æ— å¸¸ç”¨è®°å½•</div>'; return; }
        area.innerHTML = unique.map(h => `
            <div class="preset-item" onclick="quickFill('${h.brand}','${h.type}','${h.color}','${h.notes||''}')">
                <div style="width:12px; height:12px; border-radius:50%; background:${h.color}"></div>
                <div style="font-size:0.7rem; font-weight:bold;">${h.brand}</div>
                <div style="font-size:0.6rem; opacity:0.6;">${h.type}</div>
            </div>
        `).join('');
    }

    function quickFill(b,t,c,n) {
        document.getElementById('inBrand').value = b;
        document.getElementById('inType').value = t;
        document.getElementById('inColor').value = c;
        document.getElementById('inNotes').value = n;
    }

    function render() {
        const container = document.getElementById('content');
        const term = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = ''; updateCounts();
        document.documentElement.style.setProperty('--grid-cols', db.settings.columns || 2);
        
        if (currentTab === 'settings') { container.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:#999;">è®¾ç½®æ¨¡å—å¼€å‘ä¸­...å¯åœ¨æ­¤æ”¾ç½®GitHubåŒæ­¥</div>'; return; }

        let list = db[currentTab] || [];
        // æ¸²æŸ“å‰ç¡®ä¿æ—§æ•°æ®ä¹Ÿæœ‰ID
        list.forEach(i => { if(!i.id) i.id = generateId(); });

        let filtered = list.filter(i => (i.brand+i.type+(i.notes||'')).toLowerCase().includes(term));
        filtered.sort((a,b) => (a.brand||'').localeCompare(b.brand||'','zh'));

        filtered.forEach(item => {
            const txtC = getContrastColor(item.color);
            const card = document.createElement('div');
            card.className = 'card';
            card.style.backgroundColor = item.color;
            card.style.color = txtC;
            card.onclick = () => {
                activeId = item.id; 
                activeFrom = currentTab;
                document.getElementById('adjNum').value = item.count;
                showModal('adjustModal');
            };
            
            card.innerHTML = `
                <div class="brand">${item.brand}</div>
                <div class="type">${item.type}</div>
                ${item.notes ? `<div class="notes"># ${item.notes}</div>` : ''}
                <div class="count">${item.count}</div>
            `;
            container.appendChild(card);
        });
        renderTags();
    }

    // --- åŸºç¡€é€»è¾‘å¤ç”¨ ---
    function saveNew() {
        const b = document.getElementById('inBrand').value.trim(), t = document.getElementById('inType').value.trim(), 
              c = document.getElementById('inColor').value, n = parseInt(document.getElementById('inCount').value),
              nts = document.getElementById('inNotes').value.trim();
        if (!b || !t) return;

        if (isEditMode) {
            const idx = db[activeFrom].findIndex(i => i.id === activeId);
            if (idx !== -1) db[activeFrom][idx] = { ...db[activeFrom][idx], brand:b, type:t, color:c, notes:nts };
        } else {
            let exist = db.sealed.find(i => i.brand===b && i.type===t && i.color===c && i.notes===nts);
            if (exist) exist.count += n;
            else db.sealed.push({ id: generateId(), brand:b, type:t, color:c, count:n, notes:nts });
            
            if(!db.config.history) db.config.history = [];
            db.config.history.push({brand:b, type:t, color:c, notes:nts});
            if(db.config.history.length > 30) db.config.history.shift();
        }
        
        saveDB(); render(); closeModal('newModal');
        // æ¸…ç©ºè¾“å…¥
        ['inBrand','inType','inNotes'].forEach(id => document.getElementById(id).value = '');
    }

    function confirmAdj() {
        const val = parseInt(document.getElementById('adjNum').value);
        const idx = db[activeFrom].findIndex(i => i.id === activeId);
        if (idx !== -1) {
            db[activeFrom][idx].count = val;
            saveDB(); render(); closeModal('adjustModal');
        }
    }

    function stepAdjust(v) { 
        let el = document.getElementById('adjNum'); 
        el.value = Math.max(0, (parseInt(el.value)||0)+v); 
    }

    function openNewMode() { 
        isEditMode = false; 
        document.getElementById('modalActionTitle').innerText = 'è€—æå…¥åº“ç™»è®°'; 
        document.getElementById('countRow').style.display = 'block';
        showModal('newModal'); 
    }

    function openEditMode() {
        isEditMode = true;
        const item = db[activeFrom].find(i => i.id === activeId);
        document.getElementById('modalActionTitle').innerText = 'ä¿®è®¢è€—æèµ„æ–™';
        document.getElementById('inBrand').value = item.brand;
        document.getElementById('inType').value = item.type;
        document.getElementById('inNotes').value = item.notes || '';
        document.getElementById('inColor').value = item.color;
        document.getElementById('countRow').style.display = 'none';
        closeModal('adjustModal');
        showModal('newModal');
    }

    // é€šç”¨è¾…åŠ©å‡½æ•°
    function showModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='newModal') renderPresets(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function switchTab(t) { 
        currentTab = t; 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        render(); 
    }
    function getContrastColor(hex) {
        const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16);
        return ((r*299)+(g*587)+(b*114))/1000 >= 145 ? '#333' : '#fff';
    }
    function updateCounts() { ['sealed','inuse','opened','finished'].forEach(k => { document.getElementById('cnt-'+k).innerText = (db[k]||[]).reduce((s,i)=>s+i.count,0); }); }
    function renderTags() {
        const build = (cat, tags, inputId) => {
            document.getElementById(cat+'Tags').innerHTML = tags.map(t => `<span class="tag" onclick="document.getElementById('${inputId}').value='${t}'">${t}</span>`).join('');
        };
        build('brand', db.config.brands, 'inBrand');
        build('type', db.config.types, 'inType');
    }
    function showCustomWarn(t, m, lT, lC, lF, rT, rC, rF) {
        document.getElementById('warnTitle').innerText = t; document.getElementById('warnMsg').innerText = m;
        const lB = document.getElementById('warnLeftBtn'), rB = document.getElementById('warnRightBtn');
        lB.innerText = lT; lB.className = "btn " + lC; lB.onclick = lF;
        rB.innerText = rT; rB.className = "btn " + rC; rB.onclick = rF;
        showModal('warnModal');
    }
    async function startScan() { /* æ‰«æé€»è¾‘ä¿æŒä¸å˜... */ showModal('scanModal'); }
    function stopScan() { closeModal('scanModal'); }

    render();
</script>
</body>
</html>
